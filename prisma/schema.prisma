// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  Owner
  Admin
  Manager
  Worker
  Accountant
  Client
}

enum ProjectStatus {
  Planning
  InProgress
  OnHold
  Completed
  Cancelled
}

enum QuoteStatus {
  Draft
  Sent
  Approved
  Rejected
  Expired
}

enum InvoiceStatus {
  Draft
  Sent
  Paid
  Overdue
  Cancelled
}

enum JobStatus {
  Pending
  InProgress
  Completed
  Cancelled
}

enum JobPriority {
  Low
  Medium
  High
  Urgent
}

enum LineItemType {
  Labor
  Material
}

enum PurchaseOrderStatus {
  Draft
  Ordered
  Received
  Cancelled
}

enum MessageType {
  text
  file
  image
}

enum PaymentMethod {
  Cash
  Check
  BankTransfer
  CreditCard
  Other
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships CompanyMembership[]
  assignedJobs Job[]              @relation("AssignedJobs")
  chatMessages ChatMessage[]
  uploadedFiles File[]
}

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  vat       String?
  currency  String   @default("USD")
  logo      String?
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships     CompanyMembership[]
  customers      Customer[]
  projects       Project[]
  quotes         Quote[]
  invoices       Invoice[]
  jobs           Job[]
  materials      Material[]
  suppliers      Supplier[]
  purchaseOrders PurchaseOrder[]
  chatRooms      ChatRoom[]
  files          File[]
}

model CompanyMembership {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

model Customer {
  id        String   @id @default(cuid())
  companyId String
  name      String
  email     String?
  phone     String?
  address   String?
  taxId     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects  Project[]
  quotes    Quote[]
  invoices  Invoice[]

  @@index([companyId])
}

model Project {
  id          String        @id @default(cuid())
  companyId   String
  customerId  String
  name        String
  description String?
  budget      Decimal?      @db.Decimal(12, 2)
  status      ProjectStatus @default(Planning)
  progress    Int           @default(0)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  company      Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer       @relation(fields: [customerId], references: [id])
  phases       ProjectPhase[]
  jobs         Job[]
  quotes       Quote[]
  invoices     Invoice[]
  materialUsages MaterialUsage[]
  chatRooms    ChatRoom[]
  files        File[]

  @@index([companyId])
  @@index([customerId])
}

model ProjectPhase {
  id        String   @id @default(cuid())
  projectId String
  name      String
  order     Int
  status    String?
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Quote {
  id          String      @id @default(cuid())
  companyId   String
  customerId  String
  projectId   String?
  quoteNumber String      @unique
  status      QuoteStatus @default(Draft)
  subtotal    Decimal     @default(0) @db.Decimal(12, 2)
  tax         Decimal     @default(0) @db.Decimal(12, 2)
  discount    Decimal     @default(0) @db.Decimal(12, 2)
  total       Decimal     @default(0) @db.Decimal(12, 2)
  validUntil  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  company     Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer       @relation(fields: [customerId], references: [id])
  project     Project?       @relation(fields: [projectId], references: [id])
  lineItems   QuoteLineItem[]
  invoices    Invoice[]

  @@index([companyId])
  @@index([customerId])
  @@index([projectId])
}

model QuoteLineItem {
  id          String        @id @default(cuid())
  quoteId     String
  type        LineItemType
  description String
  quantity    Decimal       @db.Decimal(10, 2)
  unitPrice   Decimal       @db.Decimal(12, 2)
  total       Decimal       @db.Decimal(12, 2)
  createdAt   DateTime      @default(now())

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Invoice {
  id            String        @id @default(cuid())
  companyId     String
  customerId    String
  projectId     String?
  quoteId       String?
  invoiceNumber String        @unique
  status        InvoiceStatus @default(Draft)
  subtotal      Decimal       @default(0) @db.Decimal(12, 2)
  tax           Decimal       @default(0) @db.Decimal(12, 2)
  discount      Decimal       @default(0) @db.Decimal(12, 2)
  total         Decimal       @default(0) @db.Decimal(12, 2)
  dueDate       DateTime?
  paidDate      DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  company    Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer   Customer         @relation(fields: [customerId], references: [id])
  project    Project?         @relation(fields: [projectId], references: [id])
  quote      Quote?           @relation(fields: [quoteId], references: [id])
  lineItems  InvoiceLineItem[]
  payments   Payment[]

  @@index([companyId])
  @@index([customerId])
  @@index([projectId])
  @@index([quoteId])
}

model InvoiceLineItem {
  id          String        @id @default(cuid())
  invoiceId   String
  type        LineItemType
  description String
  quantity    Decimal       @db.Decimal(10, 2)
  unitPrice   Decimal       @db.Decimal(12, 2)
  total       Decimal       @db.Decimal(12, 2)
  createdAt   DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  amount    Decimal       @db.Decimal(12, 2)
  method    PaymentMethod
  reference String?
  paidAt    DateTime      @default(now())
  createdAt DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Job {
  id          String      @id @default(cuid())
  companyId   String
  projectId   String
  assignedToId String?
  title       String
  description String?
  status      JobStatus   @default(Pending)
  priority    JobPriority @default(Medium)
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo User?   @relation("AssignedJobs", fields: [assignedToId], references: [id])

  @@index([companyId])
  @@index([projectId])
  @@index([assignedToId])
}

model Material {
  id            String   @id @default(cuid())
  companyId     String
  name          String
  sku           String?
  category      String?
  unit          String?
  unitPrice     Decimal  @db.Decimal(12, 2)
  stockQuantity Decimal  @default(0) @db.Decimal(10, 2)
  minStockLevel Decimal? @db.Decimal(10, 2)
  supplierId    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company          Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier         Supplier?          @relation(fields: [supplierId], references: [id])
  usages           MaterialUsage[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([companyId])
  @@index([supplierId])
}

model Supplier {
  id        String   @id @default(cuid())
  companyId String
  name      String
  contact   String?
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company          Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  materials        Material[]
  purchaseOrders   PurchaseOrder[]

  @@index([companyId])
}

model MaterialUsage {
  id        String   @id @default(cuid())
  projectId String
  materialId String
  quantity  Decimal  @db.Decimal(10, 2)
  unitPrice  Decimal  @db.Decimal(12, 2)
  usedAt     DateTime @default(now())
  createdAt  DateTime @default(now())

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id])

  @@index([projectId])
  @@index([materialId])
}

model PurchaseOrder {
  id           String              @id @default(cuid())
  companyId    String
  supplierId   String
  orderNumber  String              @unique
  status       PurchaseOrderStatus @default(Draft)
  total        Decimal             @default(0) @db.Decimal(12, 2)
  orderDate    DateTime            @default(now())
  expectedDate DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  company Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier Supplier          @relation(fields: [supplierId], references: [id])
  items   PurchaseOrderItem[]

  @@index([companyId])
  @@index([supplierId])
}

model PurchaseOrderItem {
  id            String   @id @default(cuid())
  purchaseOrderId String
  materialId   String
  quantity     Decimal  @db.Decimal(10, 2)
  unitPrice     Decimal  @db.Decimal(12, 2)
  total         Decimal  @db.Decimal(12, 2)
  createdAt     DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  material      Material      @relation(fields: [materialId], references: [id])

  @@index([purchaseOrderId])
  @@index([materialId])
}

model ChatRoom {
  id        String   @id @default(cuid())
  projectId String
  companyId String
  name      String?
  createdAt DateTime @default(now())

  company  Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project  Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@unique([projectId])
  @@index([companyId])
  @@index([projectId])
}

model ChatMessage {
  id        String      @id @default(cuid())
  roomId    String
  userId    String
  content   String
  type      MessageType @default(text)
  fileUrl   String?
  createdAt DateTime    @default(now())

  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id])

  @@index([roomId])
  @@index([userId])
}

model File {
  id          String   @id @default(cuid())
  companyId   String
  projectId   String?
  uploadedById String
  filename    String
  originalName String
  mimeType    String
  size        Int
  path        String
  createdAt   DateTime @default(now())

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy  User     @relation(fields: [uploadedById], references: [id])

  @@index([companyId])
  @@index([projectId])
  @@index([uploadedById])
}

