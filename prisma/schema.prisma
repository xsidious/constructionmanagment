// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  Owner
  Admin
  Manager
  Worker
  Accountant
  Client
}

enum ProjectStatus {
  Planning
  InProgress
  OnHold
  Completed
  Cancelled
}

enum QuoteStatus {
  Draft
  Sent
  Approved
  Rejected
  Expired
}

enum InvoiceStatus {
  Draft
  Sent
  Paid
  Overdue
  Cancelled
}

enum JobStatus {
  Pending
  InProgress
  Completed
  Cancelled
}

enum JobPriority {
  Low
  Medium
  High
  Urgent
}

enum LineItemType {
  Labor
  Material
}

enum PurchaseOrderStatus {
  Draft
  Ordered
  Received
  Cancelled
}

enum MessageType {
  text
  file
  image
}

enum PaymentMethod {
  Cash
  Check
  BankTransfer
  CreditCard
  Other
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships         CompanyMembership[]
  assignedJobs        Job[]               @relation("AssignedJobs")
  chatMessages        ChatMessage[]
  uploadedFiles       File[]
  timeEntries         TimeEntry[]         @relation("TimeEntries")
  approvedTimeEntries TimeEntry[]         @relation("ApprovedTimeEntries")
  notifications       Notification[]
}

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  vat       String?
  currency  String   @default("USD")
  logo      String?
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships    CompanyMembership[]
  customers      Customer[]
  projects       Project[]
  quotes         Quote[]
  invoices       Invoice[]
  jobs           Job[]
  materials      Material[]
  suppliers      Supplier[]
  purchaseOrders PurchaseOrder[]
  chatRooms      ChatRoom[]
  files          File[]
  timeEntries    TimeEntry[]
  equipment      Equipment[]
  expenses       Expense[]
  subcontractors Subcontractor[]
  notifications  Notification[]
  reports        Report[]
}

model CompanyMembership {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

model Customer {
  id        String   @id @default(cuid())
  companyId String
  name      String
  email     String?
  phone     String?
  address   String?
  taxId     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects Project[]
  quotes   Quote[]
  invoices Invoice[]

  @@index([companyId])
}

model Project {
  id          String        @id @default(cuid())
  companyId   String
  customerId  String
  name        String
  description String?
  budget      Decimal?      @db.Decimal(12, 2)
  status      ProjectStatus @default(Planning)
  progress    Int           @default(0)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer          Customer            @relation(fields: [customerId], references: [id])
  phases            ProjectPhase[]
  jobs              Job[]
  quotes            Quote[]
  invoices          Invoice[]
  materialUsages    MaterialUsage[]
  chatRooms         ChatRoom[]
  files             File[]
  timeEntries       TimeEntry[]
  equipmentUsages   EquipmentUsage[]
  expenses          Expense[]
  subcontractorWork SubcontractorWork[]

  @@index([companyId])
  @@index([customerId])
}

model ProjectPhase {
  id        String    @id @default(cuid())
  projectId String
  name      String
  order     Int
  status    String?
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Quote {
  id          String      @id @default(cuid())
  companyId   String
  customerId  String
  projectId   String?
  quoteNumber String      @unique
  status      QuoteStatus @default(Draft)
  subtotal    Decimal     @default(0) @db.Decimal(12, 2)
  tax         Decimal     @default(0) @db.Decimal(12, 2)
  discount    Decimal     @default(0) @db.Decimal(12, 2)
  total       Decimal     @default(0) @db.Decimal(12, 2)
  validUntil  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer  Customer        @relation(fields: [customerId], references: [id])
  project   Project?        @relation(fields: [projectId], references: [id])
  lineItems QuoteLineItem[]
  invoices  Invoice[]

  @@index([companyId])
  @@index([customerId])
  @@index([projectId])
}

model QuoteLineItem {
  id          String       @id @default(cuid())
  quoteId     String
  type        LineItemType
  description String
  quantity    Decimal      @db.Decimal(10, 2)
  unitPrice   Decimal      @db.Decimal(12, 2)
  total       Decimal      @db.Decimal(12, 2)
  createdAt   DateTime     @default(now())

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Invoice {
  id            String        @id @default(cuid())
  companyId     String
  customerId    String
  projectId     String?
  quoteId       String?
  invoiceNumber String        @unique
  status        InvoiceStatus @default(Draft)
  subtotal      Decimal       @default(0) @db.Decimal(12, 2)
  tax           Decimal       @default(0) @db.Decimal(12, 2)
  discount      Decimal       @default(0) @db.Decimal(12, 2)
  total         Decimal       @default(0) @db.Decimal(12, 2)
  dueDate       DateTime?
  paidDate      DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  company   Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer  Customer          @relation(fields: [customerId], references: [id])
  project   Project?          @relation(fields: [projectId], references: [id])
  quote     Quote?            @relation(fields: [quoteId], references: [id])
  lineItems InvoiceLineItem[]
  payments  Payment[]

  @@index([companyId])
  @@index([customerId])
  @@index([projectId])
  @@index([quoteId])
}

model InvoiceLineItem {
  id          String       @id @default(cuid())
  invoiceId   String
  type        LineItemType
  description String
  quantity    Decimal      @db.Decimal(10, 2)
  unitPrice   Decimal      @db.Decimal(12, 2)
  total       Decimal      @db.Decimal(12, 2)
  createdAt   DateTime     @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  amount    Decimal       @db.Decimal(12, 2)
  method    PaymentMethod
  reference String?
  paidAt    DateTime      @default(now())
  createdAt DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Job {
  id           String      @id @default(cuid())
  companyId    String
  projectId    String
  assignedToId String?
  title        String
  description  String?
  status       JobStatus   @default(Pending)
  priority     JobPriority @default(Medium)
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project           Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo        User?               @relation("AssignedJobs", fields: [assignedToId], references: [id])
  timeEntries       TimeEntry[]
  equipmentUsages   EquipmentUsage[]
  subcontractorWork SubcontractorWork[]

  @@index([companyId])
  @@index([projectId])
  @@index([assignedToId])
}

model Material {
  id            String   @id @default(cuid())
  companyId     String
  name          String
  sku           String?
  category      String?
  unit          String?
  unitPrice     Decimal  @db.Decimal(12, 2)
  stockQuantity Decimal  @default(0) @db.Decimal(10, 2)
  minStockLevel Decimal? @db.Decimal(10, 2)
  supplierId    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  usages             MaterialUsage[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([companyId])
  @@index([supplierId])
}

model Supplier {
  id        String   @id @default(cuid())
  companyId String
  name      String
  contact   String?
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  materials      Material[]
  purchaseOrders PurchaseOrder[]

  @@index([companyId])
}

model MaterialUsage {
  id         String   @id @default(cuid())
  projectId  String
  materialId String
  quantity   Decimal  @db.Decimal(10, 2)
  unitPrice  Decimal  @db.Decimal(12, 2)
  usedAt     DateTime @default(now())
  createdAt  DateTime @default(now())

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id])

  @@index([projectId])
  @@index([materialId])
}

model PurchaseOrder {
  id           String              @id @default(cuid())
  companyId    String
  supplierId   String
  orderNumber  String              @unique
  status       PurchaseOrderStatus @default(Draft)
  total        Decimal             @default(0) @db.Decimal(12, 2)
  orderDate    DateTime            @default(now())
  expectedDate DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  company  Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]

  @@index([companyId])
  @@index([supplierId])
}

model PurchaseOrderItem {
  id              String   @id @default(cuid())
  purchaseOrderId String
  materialId      String
  quantity        Decimal  @db.Decimal(10, 2)
  unitPrice       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  material      Material      @relation(fields: [materialId], references: [id])

  @@index([purchaseOrderId])
  @@index([materialId])
}

model ChatRoom {
  id        String   @id @default(cuid())
  projectId String
  companyId String
  name      String?
  createdAt DateTime @default(now())

  company  Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project  Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@unique([projectId])
  @@index([companyId])
  @@index([projectId])
}

model ChatMessage {
  id        String      @id @default(cuid())
  roomId    String
  userId    String
  content   String
  type      MessageType @default(text)
  fileUrl   String?
  createdAt DateTime    @default(now())

  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id])

  @@index([roomId])
  @@index([userId])
}

model File {
  id           String   @id @default(cuid())
  companyId    String
  projectId    String?
  uploadedById String
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  createdAt    DateTime @default(now())

  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project    Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy User     @relation(fields: [uploadedById], references: [id])

  @@index([companyId])
  @@index([projectId])
  @@index([uploadedById])
}

enum TimeEntryStatus {
  Pending
  Approved
  Rejected
}

model TimeEntry {
  id           String          @id @default(cuid())
  companyId    String
  userId       String
  projectId    String?
  jobId        String?
  date         DateTime
  hours        Decimal         @db.Decimal(5, 2)
  description  String?
  status       TimeEntryStatus @default(Pending)
  hourlyRate   Decimal?        @db.Decimal(12, 2)
  totalAmount  Decimal?        @db.Decimal(12, 2)
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user       User     @relation("TimeEntries", fields: [userId], references: [id])
  project    Project? @relation(fields: [projectId], references: [id])
  job        Job?     @relation(fields: [jobId], references: [id])
  approvedBy User?    @relation("ApprovedTimeEntries", fields: [approvedById], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([projectId])
  @@index([jobId])
  @@index([date])
}

enum EquipmentStatus {
  Available
  InUse
  Maintenance
  Retired
}

enum EquipmentType {
  Vehicle
  Tool
  Machinery
  Other
}

model Equipment {
  id            String          @id @default(cuid())
  companyId     String
  name          String
  type          EquipmentType
  status        EquipmentStatus @default(Available)
  serialNumber  String?
  model         String?
  manufacturer  String?
  purchaseDate  DateTime?
  purchasePrice Decimal?        @db.Decimal(12, 2)
  currentValue  Decimal?        @db.Decimal(12, 2)
  location      String?
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  company     Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usages      EquipmentUsage[]
  maintenance EquipmentMaintenance[]

  @@index([companyId])
  @@index([status])
}

model EquipmentUsage {
  id          String    @id @default(cuid())
  equipmentId String
  projectId   String?
  jobId       String?
  startDate   DateTime
  endDate     DateTime?
  notes       String?
  createdAt   DateTime  @default(now())

  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id])
  job       Job?      @relation(fields: [jobId], references: [id])

  @@index([equipmentId])
  @@index([projectId])
  @@index([jobId])
}

model EquipmentMaintenance {
  id          String    @id @default(cuid())
  equipmentId String
  type        String // Service, Repair, Inspection
  description String?
  cost        Decimal?  @db.Decimal(12, 2)
  date        DateTime
  nextDueDate DateTime?
  performedBy String?
  notes       String?
  createdAt   DateTime  @default(now())

  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([date])
}

enum ExpenseCategory {
  Materials
  Labor
  Equipment
  Subcontractor
  Travel
  Utilities
  Insurance
  Other
}

model Expense {
  id          String          @id @default(cuid())
  companyId   String
  projectId   String?
  category    ExpenseCategory
  amount      Decimal         @db.Decimal(12, 2)
  description String
  receiptUrl  String?
  date        DateTime
  vendor      String?
  paidBy      String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])

  @@index([companyId])
  @@index([projectId])
  @@index([category])
  @@index([date])
}

model Subcontractor {
  id         String   @id @default(cuid())
  companyId  String
  name       String
  email      String?
  phone      String?
  address    String?
  taxId      String?
  specialty  String?
  hourlyRate Decimal? @db.Decimal(12, 2)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company    Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  workOrders SubcontractorWork[]

  @@index([companyId])
}

model SubcontractorWork {
  id              String    @id @default(cuid())
  subcontractorId String
  projectId       String?
  jobId           String?
  description     String
  amount          Decimal   @db.Decimal(12, 2)
  startDate       DateTime?
  endDate         DateTime?
  status          String    @default("Pending")
  invoiceNumber   String?
  paidDate        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  subcontractor Subcontractor @relation(fields: [subcontractorId], references: [id], onDelete: Cascade)
  project       Project?      @relation(fields: [projectId], references: [id])
  job           Job?          @relation(fields: [jobId], references: [id])

  @@index([subcontractorId])
  @@index([projectId])
  @@index([jobId])
}

enum NotificationType {
  ProjectUpdate
  InvoiceDue
  JobAssigned
  MaterialLowStock
  PaymentReceived
  QuoteApproved
  SystemAlert
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  companyId String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([read])
  @@index([createdAt])
}

model Report {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  type        String // Financial, Project, Inventory, etc.
  parameters  Json?
  generatedAt DateTime @default(now())
  generatedBy String
  fileUrl     String?
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([generatedAt])
}
